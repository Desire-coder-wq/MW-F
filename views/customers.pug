doctype html
html(lang="en")
  head
    meta(charset="UTF-8")
    meta(name="viewport", content="width=device-width,initial-scale=1")
    title= title
    link(rel="stylesheet", href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css")
    link(rel="stylesheet", href="/css/customer.css")
    script(src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js")
    script(src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js")

  body
    .layout
      aside.sidebar
        .logo-container
          img.logo-img(src="/images/logo 2.png", alt="MWF Logo")
          .logo-text Mayondo Wood & Furniture
          button.hamburger-menu#sidebarToggle
            .hamburger-line
            .hamburger-line
            .hamburger-line
        nav
          ul
            li
              a(href="/stockList")
                i.fas.fa-boxes
                span Stock
            li
              a(href="/suppliers")
                i.fas.fa-truck
                span Suppliers
            li
              a(href="/customers", class="active")
                i.fas.fa-users
                span Customers
            li
              a(href="/logout")
                i.fas.fa-sign-out-alt
                span Logout

      .main-content
        // ---- Topbar ----
        #topbar
          .header-content
            .company-info
              h1 Customers Dashboard
              h3 Manage and view customers
            .header-actions
              a.back-btn(href="/manager-dashboard")
                i.fas.fa-arrow-left
                | Back to Dashboard
              .notification-btn#notificationBtn
                i.fas.fa-bell
                .notification-count 3

        .container
          // ---- Customers Header ----
          .customers-header
            .header-text
              h1 Customers Information
              p Here are all customers automatically captured from sales entries.
            .customer-actions
              button.export-btn(type="button", id="exportPdf")
                i.fas.fa-download
                | Export to PDF

          // ---- Stats Section ----
          .customer-stats
            .customer-stat-card
              .customer-stat-icon(style="background: #dcfce7; color: #166534;")
                i.fas.fa-users
              .customer-stat-info
                h3 0
                p Total Customers
            .customer-stat-card
              .customer-stat-icon(style="background: #fef3c7; color: #92400e;")
                i.fas.fa-shopping-cart
              .customer-stat-info
                h3 0
                p Active Customers
            .customer-stat-card
              .customer-stat-icon(style="background: #dcfce7; color: #166534;")
                i.fas.fa-envelope
              .customer-stat-info
                h3 0
                p With Email
            .customer-stat-card
              .customer-stat-icon(style="background: #fef3c7; color: #92400e;")
                i.fas.fa-phone
              .customer-stat-info
                h3 0
                p With Contact

          // ---- Table Section ----
          .table-section
            .table-container
              if customers && customers.length
                table.customers-table
                  thead
                    tr
                      th
                        i.fas.fa-user
                        | Customer Name
                      th
                        i.fas.fa-envelope
                        | Email
                      th
                        i.fas.fa-phone
                        | Contact
                      th
                        i.fas.fa-map-marker-alt
                        | Address
                      th
                        i.fas.fa-calendar
                        | Date Added
                      th
                        i.fas.fa-cog
                        | Actions
                  tbody
                    each customer in customers
                      tr
                        td= customer.customerName
                        td= customer.customerPhone || '-'
                        td= customer.customerEmail || '-'
                        td= customer.customerAddress || '-'
                        td= customer.dateAdded ? new Date(customer.dateAdded).toDateString() : '-'
                        td.actions-cell
                          form.delete-form(action=`/customers/${customer._id}/delete`, method="POST")
                            button.btn-delete(type="submit")
                              i.fas.fa-trash
                              | Delete
              else
                p.no-data No customer records found.

        footer
          .container
            p &copy; 2025 Mayondo Wood & Furniture Ltd 
            p Designed by A Rose Desire @ Groundbreaker Talents

    script.
      const customers = != JSON.stringify(customers || []);

      document.addEventListener("DOMContentLoaded", () => {
        const totalCustomers = customers.length;
        const activeCustomers = totalCustomers;
        const customersWithEmail = customers.filter(c => c.email && c.email !== '-').length;
        const customersWithContact = customers.filter(c => c.contact && c.contact !== '-').length;

        const stats = document.querySelectorAll('.customer-stat-info h3');
        if (stats.length >= 4) {
          stats[0].textContent = totalCustomers;
          stats[1].textContent = activeCustomers;
          stats[2].textContent = customersWithEmail;
          stats[3].textContent = customersWithContact;
        }

        // Sidebar toggle functionality
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebar = document.querySelector('.sidebar');
        const mainContent = document.querySelector('.main-content');

        sidebarToggle.addEventListener('click', () => {
          sidebar.classList.toggle('collapsed');
          mainContent.classList.toggle('expanded');
        });

        // PDF Export functionality
        const exportPdfBtn = document.getElementById('exportPdf');
        exportPdfBtn.addEventListener('click', exportToPdf);

        function exportToPdf() {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();
          
          // Add title
          doc.setFontSize(20);
          doc.text('Customers Report - Mayondo Wood & Furniture', 14, 15);
          
          // Add date
          doc.setFontSize(10);
          doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 14, 22);
          
          // Add statistics
          doc.setFontSize(12);
          doc.text(`Total Customers: ${totalCustomers}`, 14, 32);
          doc.text(`Active Customers: ${activeCustomers}`, 14, 38);
          doc.text(`Customers with Email: ${customersWithEmail}`, 14, 44);
          doc.text(`Customers with Contact: ${customersWithContact}`, 14, 50);
          
          // Add table headers
          let yPosition = 65;
          doc.setFontSize(10);
          doc.setFont(undefined, 'bold');
          doc.text('Name', 14, yPosition);
          doc.text('Email', 50, yPosition);
          doc.text('Contact', 90, yPosition);
          doc.text('Address', 130, yPosition);
          doc.text('Date Added', 170, yPosition);
          
          yPosition += 8;
          doc.setFont(undefined, 'normal');
          
          // Add customer data
          customers.forEach((customer) => {
            if (yPosition > 270) {
              doc.addPage();
              yPosition = 20;
            }
            
            doc.text(customer.name || '-', 14, yPosition);
            doc.text(customer.email || '-', 50, yPosition);
            doc.text(customer.contact || '-', 90, yPosition);
            doc.text(customer.address || '-', 130, yPosition);
            doc.text(customer.dateAdded ? new Date(customer.dateAdded).toLocaleDateString() : '-', 170, yPosition);
            
            yPosition += 6;
          });
          
          // Save the PDF
          doc.save(`customers_report_${new Date().toISOString().split('T')[0]}.pdf`);
        }
      });
