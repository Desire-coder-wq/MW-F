doctype html
html(lang="en")
  head
    meta(charset="UTF-8")
    meta(name="viewport", content="width=device-width, initial-scale=1")
    title MWF â€” Attendants
    link(rel="stylesheet", href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css")
    link(rel="stylesheet", href="/css/attendant-manage.css")
    style.
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        overflow: auto;
      }
      .modal-content {
        background-color: white;
        margin: 50px auto;
        padding: 25px;
        border-radius: 10px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        position: relative;
      }
      .close {
        color: #aaa;
        position: absolute;
        top: 15px;
        right: 20px;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
      }
      .close:hover { color: black; }
      .form-group { margin-bottom: 15px; }
      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #333;
        font-size: 14px;
      }
      .form-group input, .form-group select, .form-group textarea {
        width: 100%;
        padding: 8px 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
        box-sizing: border-box;
      }
      .form-group textarea {
        height: 80px;
        resize: vertical;
      }
      .form-group.checkbox {
        display: flex;
        align-items: center;
        gap: 8px;
        margin: 20px 0;
      }
      .form-group.checkbox input {
        width: auto;
      }
      .form-group.checkbox label {
        margin: 0;
        font-weight: normal;
      }
      .btn-assign {
        background: #28a745;
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        width: 100%;
        margin-top: 10px;
      }
      .btn-assign:hover { background: #81b53eff; }
      .btn-task {
        background: #28a745;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        margin-left: 5px;
      }
      .btn-task:hover { background: #218838; }
      .alert-message {
        padding: 10px 15px;
        margin: 10px 0;
        border-radius: 4px;
        font-weight: 500;
      }
      .alert-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .alert-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .modal-title {
        margin: 0 0 20px 0;
        color: #2c5aa0;
        font-size: 20px;
      }
      .back-btn {
        background: #1e293b;
        color: white;
        border: none;
        padding: 10px 18px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .back-btn:hover { background: #334155; }

  body
    .layout
      //- Sidebar
      aside.sidebar
        .logo-container
          img.logo-img(src="/images/logo 2.png", alt="MWF Logo")
          .logo-text Mayondo Wood & Furniture
        nav
          ul
            li
              a(href="/reports")
                i.fas.fa-chart-bar
                span Reports
            li
              a(href="/approve-stock")
                i.fas.fa-check-circle
                span Approve Stock
            li
              a(href="/stock")
                i.fas.fa-boxes
                span Add Stock
            li
              a(href="/sales-report")
                i.fas.fa-file-invoice-dollar
                span Sales Reports
            li
              a(href="/attendants", class="active")
                i.fas.fa-users
                span Attendants
            li
              a(href="/task-reports")
                i.fas.fa-clipboard-check
                span Task Reports
            li
              a(href="/logout")
                i.fas.fa-sign-out-alt
                span Logout

      //- Topbar
      #topbar
        .header-content
          .company-info
            h1 Attendants Monitoring
            h3 View and manage attendant activities
          .header-actions
            button.back-btn(onclick="goToManagerDashboard()")
              i.fas.fa-arrow-left
              | Back to Manager Dashboard
            .notification-btn
              i.fas.fa-bell
              .notification-count 0
            .user-profile
              i.fas.fa-user-circle
              span Manager

      //- Main Content
      .container
        if message
          .alert-message.alert-success= message
        if error
          .alert-message.alert-error= error

        .table-section
          .table-header
            h3
              i.fas.fa-users
              | Attendants List
            button.btn-assign(onclick="openAssignTaskModal()")
              i.fas.fa-tasks
              | Assign New Task
          .table-container
            table.attendants-table
              thead
                tr
                  th 
                    i.fas.fa-user
                    | Name
                  th 
                    i.fas.fa-envelope
                    | Email
                  th 
                    i.fas.fa-tasks
                    | Assigned Task
                  th 
                    i.fas.fa-circle
                    | Status
                  th 
                    i.fas.fa-clock
                    | Last Active
                  th 
                    i.fas.fa-cog
                    | Actions
              tbody
                if attendants && attendants.length
                  each att in attendants
                    tr
                      td= att.user ? att.user.name : ""
                      td= att.user ? att.user.email : ""
                      td= att.assignedTask
                      td
                        span(class=att.status ? att.status.toLowerCase() + "-status" : "inactive-status")= att.status
                      td= att.lastActive ? att.lastActive.toLocaleString() : ""
                      td.actions-cell
                        button.btn-task(onclick=`openAssignTaskModal('${att._id}', '${att.user ? att.user.name : ""}')`)
                          i.fas.fa-tasks
                          | Assign Task
                        form(action=`/attendants/${att._id}/toggle`, method="POST", style="display: inline;")
                          button(type="submit", class=att.status === "Active" ? "btn-delete" : "btn-edit")
                            i.fas.fa-power-off
                            | #{att.status === "Active" ? "Disable" : "Enable"}
                else
                  tr
                    td(colspan="6", style="text-align:center;")
                      i.fas.fa-users
                      | No attendants found.

    //- Task Assignment Modal
    #taskModal.modal
      .modal-content
        span.close(onclick="closeAssignTaskModal()") &times;
        h3.modal-title
          i.fas.fa-tasks
          | Assign Task to Attendant
        
        form#taskForm(action="/attendants/assign-task", method="POST")
          .form-group
            label(for="attendantSelect") Select Attendant:
            select#attendantSelect(name="attendantId", required)
              option(value="") -- Select Attendant --
              each att in attendants
                option(value=att._id)= att.user ? att.user.name : ""
          
          .form-group
            label(for="taskType") Task Type:
            select#taskType(name="taskType", required)
              option(value="") -- Select Task Type --
              option(value="stock_management") Stock Management
              option(value="sales_processing") Sales Processing
              option(value="customer_service") Customer Service
              option(value="loading_supervision") Loading Supervision
              option(value="offloading_supervision") Offloading Supervision
              option(value="inventory_check") Inventory Check
              option(value="report_generation") Report Generation
          
          .form-group
            label(for="taskDescription") Task Description:
            textarea#taskDescription(name="taskDescription", placeholder="Describe the task...", required)
          
          .form-group
            label(for="dueDate") Due Date:
            input#dueDate(type="datetime-local", name="dueDate", required)
          
          .form-group
            label(for="priority") Priority:
            select#priority(name="priority", required)
              option(value="low") Low
              option(value="medium") Medium
              option(value="high") High
          
          .form-group.checkbox
            input(type="checkbox", name="sendEmail", id="sendEmail", checked)
            label(for="sendEmail") Send email notification to attendant
          
          button.btn-assign(type="submit")
            i.fas.fa-paper-plane
            | Assign Task

    footer
      .container
         p &copy; 2025 Mayondo Wood & Furniture Ltd 
         p Designed by A Rose Desire @ Groundbreaker Talents

  script.
    function openAssignTaskModal(attendantId = '', attendantName = '') {
      const modal = document.getElementById('taskModal');
      const attendantSelect = document.getElementById('attendantSelect');
      
      if (attendantId && attendantName) {
        attendantSelect.value = attendantId;
      }
      
      modal.style.display = 'block';
      const today = new Date().toISOString().slice(0, 16);
      document.getElementById('dueDate').min = today;
    }

    function closeAssignTaskModal() {
      const modal = document.getElementById('taskModal');
      modal.style.display = 'none';
      document.getElementById('taskForm').reset();
    }

    function goToManagerDashboard() {
      window.location.href = "/manager-dashboard"; // update route if different
    }

    window.onclick = function(event) {
      const modal = document.getElementById('taskModal');
      if (event.target === modal) closeAssignTaskModal();
    }

    document.addEventListener('DOMContentLoaded', function() {
      const managerName = '#{user ? user.name : "Manager"}';
      document.querySelector('.user-profile span').textContent = managerName;
    });
